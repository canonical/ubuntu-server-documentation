name: Update Redirected URLs

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-redirects:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install documentation dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make python3-venv
          make install
      
      - name: Generate initial linkcheck
        id: linkcheck
        run: |
          cd docs
          make linkcheck > linkcheck.txt 2>&1 || true
          cd ..
          
          # Check if there are any redirects to process
          if grep -q "redirected" docs/_build/output.txt 2>/dev/null; then
            echo "redirects_found=true" >> $GITHUB_OUTPUT
            echo "Found redirects to process"
          else
            echo "redirects_found=false" >> $GITHUB_OUTPUT
            echo "No redirects found"
          fi
      
      - name: Run redirect update script
        if: steps.linkcheck.outputs.redirects_found == 'true'
        id: update
        run: |
          python3 update_redirects.py
          echo "script_exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Check for changes
        if: steps.linkcheck.outputs.redirects_found == 'true'
        id: changes
        run: |
          if git diff --quiet docs/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            
            # Count changed files
            changed_files=$(git diff --name-only docs/ | wc -l)
            echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate PR body
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          {
            echo 'PR_BODY<<EOF'
            echo '## Automated Redirect URL Updates'
            echo ''
            echo 'This PR automatically updates redirected URLs in the documentation to their final destinations.'
            echo ''
            echo '### Summary'
            echo ''
            cat redirect_update_report.md
            echo ''
            echo '---'
            echo ''
            echo '### Files Changed'
            echo ''
            echo "**Total files modified:** ${{ steps.changes.outputs.changed_files }}"
            echo ''
            echo '<details>'
            echo '<summary>Click to see all changed files</summary>'
            echo ''
            echo '```'
            git diff --name-only docs/
            echo '```'
            echo ''
            echo '</details>'
            echo ''
            echo '### Review Checklist'
            echo ''
            echo '- [ ] Review the redirect changes in the summary above'
            echo '- [ ] Verify that validation passed (✅ PASSED status)'
            echo '- [ ] Spot-check a few URL changes to ensure they are correct'
            echo '- [ ] Run `make linkcheck` locally if needed'
            echo ''
            echo '---'
            echo ''
            echo '*This PR was automatically generated by the `update-redirects` GitHub Action.*'
            echo '*Scheduled to run every Monday at 9:00 AM UTC.*'
            echo 'EOF'
          } >> $GITHUB_ENV
      
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: Update redirected URLs to final destinations
            
            - Updated ${{ steps.changes.outputs.changed_files }} documentation files
            - Fixed redirected URLs found by linkcheck
            - All changes validated successfully
          branch: automated/redirect-updates-${{ github.run_number }}
          delete-branch: true
          title: 'docs: Update redirected URLs (automated)'
          body: ${{ env.PR_BODY }}
          labels: |
            documentation
            automated
            links
          assignees: ${{ github.repository_owner }}
          draft: false
      
      - name: Upload reports as artifacts
        if: steps.linkcheck.outputs.redirects_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: redirect-update-reports
          path: |
            redirect_update_report.md
            redirect_changes_summary.json
          retention-days: 30
      
      - name: Comment on workflow run
        if: steps.changes.outputs.has_changes == 'false' && steps.linkcheck.outputs.redirects_found == 'true'
        run: |
          echo "::notice::No changes needed - all redirects may have been already fixed or skipped"
      
      - name: Summary
        if: always()
        run: |
          echo "### Redirect Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.linkcheck.outputs.redirects_found }}" == "false" ]; then
            echo "✅ No redirects found in the documentation" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ Pull request created with redirect updates" >> $GITHUB_STEP_SUMMARY
            echo "- Files changed: ${{ steps.changes.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" == "false" ]; then
            echo "ℹ️ Redirects found but no changes needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Workflow completed with issues" >> $GITHUB_STEP_SUMMARY
          fi
