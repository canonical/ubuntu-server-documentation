(install-exim4)=
# Install and configure Exim4

## Install Exim4

To install [Exim4](https://www.exim.org/), run the following command:

```bash
sudo apt install exim4
```

## Configure Exim4

To configure Exim4, run the following command:

```bash
sudo dpkg-reconfigure exim4-config
```

This displays a "wizard" user interface for configuring the software. One important question in this configuration is whether exim4 should use split configuration files, or a single configuration file.

If using multiple configuration files, then the configuration will be split in a directory structure under `/etc/exim4/conf.d`, like so:
```text
/etc/exim4/
└── conf.d
    ├── acl
    ├── auth
    ├── main
    ├── retry
    ├── rewrite
    ├── router
    └── transport
```
Each subdirectory will contain one or more individual configuration files.

If, however, exim4 was setup to use a single configuration file (which is the default), then that file will be `/etc/exim4/exim4.conf.template`. It will essentially be as if all individual configuration files from the previous layout were concatenated into a big single file.

```{note}
The default configuration layout for exim4 is the single configuration file one.
```

In any of these scenarios, after making a change to the configuration, the following command must be executed to update the actual configuration file that exim4 will use:

```text
sudo update-exim4.conf
```

The `update-exim4.conf` command will update the master configuration file stored in `/var/lib/exim4/config.autogenerated`.

```{warning}
You should never manually edit the master configuration file, `/var/lib/exim4/config.autogenerated`, because it is updated automatically every time you run `update-exim4.conf`. Any changes you make to this file will be lost during future updates.
```

If configuration changes were made, the service should also be restarted:
```text
sudo systemctl restart exim4
```

All the choices made via `dpkg-reconfigure exim4-config` are stored in the `/etc/exim4/update-exim4.conf.conf` file. To re-configure the software you can either re-run `dpkg-reconfigure` as before, or manually edit this file using your preferred editor.


## Start the Exim4 daemon

The following command will start the Exim4 daemon:

```bash
sudo service exim4 start
```

## SMTP authentication

Exim4 can be configured to use SMTP-AUTH with Transport Layer Security (TLS) and Simple Authentication and Security Layer (SASL).

First, enter the following into a terminal prompt to create a certificate for use with TLS:

```bash
sudo /usr/share/doc/exim4-base/examples/exim-gencert
```

Configure Exim4 for TLS by editing the `/etc/exim4/conf.d/main/03_exim4-config_tlsoptions` file and adding the following:

```text
MAIN_TLS_ENABLE = yes
```

Next, configure Exim4 to use the `saslauthd` daemon for authentication by editing `/etc/exim4/conf.d/auth/30_exim4-config_examples` -- uncomment the `plain_saslauthd_server` and `login_saslauthd_server` sections:

```text 
plain_saslauthd_server:
  driver = plaintext
  public_name = PLAIN
  server_condition = ${if saslauthd{{$auth2}{$auth3}}{1}{0}}
  server_set_id = $auth2
  server_prompts = :
  .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDS
  server_advertise_condition = ${if eq{$tls_cipher}{}{}{*}}
  .endif

login_saslauthd_server:
  driver = plaintext
  public_name = LOGIN
  server_prompts = "Username:: : Password::"
  # don't send system passwords over unencrypted connections
  server_condition = ${if saslauthd{{$auth1}{$auth2}}{1}{0}}
  server_set_id = $auth1
  .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDS
  server_advertise_condition = ${if eq{$tls_cipher}{}{}{*}}
  .endif
```

To enable outside mail clients to connect to the new server, a new user needs to be added into Exim4 by using the following commands:

```bash
sudo /usr/share/doc/exim4-base/examples/exim-adduser
```

Protect the new password files with the following commands:

```bash
sudo chown root:Debian-exim /etc/exim4/passwd
sudo chmod 640 /etc/exim4/passwd
```

Finally, update the Exim4 configuration and restart the service:

```bash
sudo update-exim4.conf
sudo systemctl restart exim4.service
```

## Configure SASL

To configure `saslauthd` to provide authentication for Exim4, first install the `sasl2-bin` package by running this command at a terminal prompt:

```bash
sudo apt install sasl2-bin
```

To configure `saslauthd`, edit the `/etc/default/saslauthd` configuration file and set:

```text
START=yes
```

Next, to make Exim4 use the `saslauthd` service, the *Debian-exim* user needs to be part of the *sasl* group:

```bash
sudo adduser Debian-exim sasl
```

Finally, start the `saslauthd` service:

```bash
sudo service saslauthd start
```

Exim4 is now configured with SMTP-AUTH using TLS and SASL authentication.

## References

  - See [exim.org](http://www.exim.org/) for more information.

  - Another resource is the [Exim4 Ubuntu Wiki](https://help.ubuntu.com/community/Exim4) page.

  - Further resources to [set up mailman3 with Exim4](https://mailman.readthedocs.io/en/latest/src/mailman/docs/mta.html#exim).
