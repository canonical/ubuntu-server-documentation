(install-exim4)=
# Install and configure Exim4

## Install Exim4

To install [Exim4](https://www.exim.org/), run the following command:

```bash
sudo apt install exim4
```

## Configure Exim4

To configure Exim4, run the following command:

```bash
sudo dpkg-reconfigure exim4-config
```

This displays a "wizard" user interface for configuring the software. One important question in this configuration is whether exim4 should use split configuration files, or a single configuration file.

If using multiple configuration files, then the configuration will be split in a directory structure under `/etc/exim4/conf.d`, like so:
```text
/etc/exim4/
└── conf.d
    ├── acl
    ├── auth
    ├── main
    ├── retry
    ├── rewrite
    ├── router
    └── transport
```
Each subdirectory will contain one or more individual configuration files.

If, however, exim4 was setup to use a single configuration file (which is the default), then that file will be `/etc/exim4/exim4.conf.template`. It will essentially be as if all individual configuration files from the previous layout were concatenated into a big single file.

```{note}
The default configuration layout for exim4 is the single configuration file one.
```

In any of these scenarios, after making a change to the configuration, the following command must be executed to update the actual configuration file that exim4 will use:

```text
sudo update-exim4.conf
```

The `update-exim4.conf` command will update the master configuration file stored in `/var/lib/exim4/config.autogenerated`.

```{warning}
You should never manually edit the master configuration file, `/var/lib/exim4/config.autogenerated`, because it is updated automatically every time you run `update-exim4.conf`. Any changes you make to this file will be lost during future updates.
```

If configuration changes were made, the service should also be restarted:
```text
sudo systemctl restart exim4
```

All the choices made via `dpkg-reconfigure exim4-config` are stored in the `/etc/exim4/update-exim4.conf.conf` file. To re-configure the software you can either re-run `dpkg-reconfigure` as before, or manually edit this file using your preferred editor.


## Start the Exim4 daemon

The following command will start the Exim4 daemon:

```bash
sudo service exim4 start
```

## SMTP authentication

There are multiple authentication options available for Exim4. Here we will document two methods:

 * Authenticate Linux users present in the local shadow file (`/etc/shadow`), via `saslauthd` and PAM.
 * Authenticate arbitrary users against a custom Exim4 password database (`/etc/exim4/passwd`).

Both of these methods use clear text passwords transmitted over the network, so they need to be protected by Transport Layer Security (TLS).

```{warning}
All configuration steps shown from now on will assume a split-configuration mode for Exim4. If you have selected the non-split mode, then all commands that edit a configuration file under `/etc/exim4/conf.d` in the sections below should be replaced with editing the single file `/etc/exim4/exim4.conf.template`.
```

### Enabling TLS

First, enter the following into a terminal prompt to create a certificate for use with TLS:

```bash
sudo /usr/share/doc/exim4-base/examples/exim-gencert
```
This command will ask some questions about the certificate, like country, city, and others. The most important one, and that must be correct otherwise TLS won't work for this server, is the "Server name" one. It **MUST** match the fully qualified hostname (FQDN) of the system where Exim4 is deployed.

```{warning}
This will install a self-signed certificate. If deploying this system in production, you must get a proper certificate signed by a recognized Certificate Authority (CA), or, if using an internal, you will have to distribute the CA to all clients expected to connect to this server.
```
Configure Exim4 for TLS by editing the `/etc/exim4/conf.d/main/03_exim4-config_tlsoptions` file and adding the following:

```text
MAIN_TLS_ENABLE = yes
```

### Authenticating existing Linux users

To authenticate existing Linux users, that is, users who already have accounts on this system, we will use the `saslauthd` service.

```{note}
To manage local Linux users, please refer to {ref}`User management <user-management>`.
```

Configure Exim4 to use the `saslauthd` daemon for authentication by editing `/etc/exim4/conf.d/auth/30_exim4-config_examples` -- uncomment the `plain_saslauthd_server` and `login_saslauthd_server` sections:

```text 
plain_saslauthd_server:
  driver = plaintext
  public_name = PLAIN
  server_condition = ${if saslauthd{{$auth2}{$auth3}}{1}{0}}
  server_set_id = $auth2
  server_prompts = :
  .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDS
  server_advertise_condition = ${if eq{$tls_cipher}{}{}{*}}
  .endif

login_saslauthd_server:
  driver = plaintext
  public_name = LOGIN
  server_prompts = "Username:: : Password::"
  # don't send system passwords over unencrypted connections
  server_condition = ${if saslauthd{{$auth1}{$auth2}}{1}{0}}
  server_set_id = $auth1
  .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDS
  server_advertise_condition = ${if eq{$tls_cipher}{}{}{*}}
  .endif
```

This will enable the `PLAIN` and `LOGIN` authentication mechanisms via `saslauthd`.

To make these changes effective, the main configuration file needs to be updated, and Exim4 restarted:
```text
sudo update-exim4.conf
sudo systemctl restart exim4
```

This concludes the Exim4 side of the configuration. Next, the `sasl2-bin` package needs to be installed:

```text
sudo apt install sasl2-bin
```

The main configuration for `saslauthd` is in the `/etc/default/saslauthd` file. What needs to be verified is the `MECHANISMS` setting, which we want to be `PAM`:
```
MECHANISMS="pam"
```

```{note}
In Ubuntu 22.04 Jammy and earlier, we also need to add `START=yes` to `/etc/default/saslauthd`.
```

Finally, enable and start the `saslauthd` service:

```text
sudo systemctl enable --now saslauthd
```
Exim4 is now configured with SMTP-AUTH using TLS authenticating local Linux users via PAM.

### Authenticating arbitrary users

Exim4 can also be configured to authenticate arbitrary users, that is, users that do note exist on the local system. These mechanisms are called `plain_server` and `login_server`. Edit `/etc/exim4/conf.d/auth/30_exim4-config_examples` and uncomment these sections:
```text
plain_server:
  driver = plaintext
  public_name = PLAIN
  server_condition = "${if crypteq{$auth3}{${extract{1}{:}{${lookup{$auth2}lsearch{CONFDIR/passwd}{$value}{*:*}}}}}{1}{0}}"
  server_set_id = $auth2
  server_prompts = :
  .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDS
  server_advertise_condition = ${if eq{$tls_in_cipher}{}{}{*}}
  .endif

login_server:
  driver = plaintext
  public_name = LOGIN
  server_prompts = "Username:: : Password::"
  server_condition = "${if crypteq{$auth2}{${extract{1}{:}{${lookup{$auth1}lsearch{CONFDIR/passwd}{$value}{*:*}}}}}{1}{0}}"
  server_set_id = $auth1
  .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDS
  server_advertise_condition = ${if eq{$tls_in_cipher}{}{}{*}}
  .endif
```

```{warning}
DO NOT enable both these and the `_saslauthd_server` variants (from "Authenticating existing Linux users" above) at the same time!
```

These mechanisms will lookup usernames and passwords in the `/etc/exim4/passwd` file, which has to be created and populated. The format of this file is:
```text
username:crypted-password:cleartext-password
```

The Exim4 installation ships a helper script that can populate this file. It is a simple interactive script that can be run like this:
```text
sudo /usr/share/doc/exim4-base/examples/exim-adduser
```

It will prompt for a username and password. In this example we are creating an `ubuntu` entry with the password `ubuntusecret`:
```text
User: ubuntu
Password: ubuntusecret
```
After that, we will have a `/etc/exim4/passwd` file, owned by `root:root` and mode `0644`, with contents similar to this:
```text
ubuntu:$1$ZvPA$HTddFobmJD1vURtJHBmbw/:ubuntusecret
```

Since this file contains secrets, it should be protected, and Exim4 has to be allowed to read it:
```text
sudo chown root:Debian-exim /etc/exim4/passwd
sudo chmod 0640 /etc/exim4/passwd
```

The same script can also be used to manage users in this `passwd` file:

 * To change the password of an existing user, edit the `passwd` file, delete the line corresponding to the user, save the file, and run the script again to provide the new password.
 * To add another user, run the script and provide the new user name, and their password.
 * To remove a user, edit the file with a text editor and delete the line corresponding to the user that should be removed.

```{warning}
The `/usr/share/doc/exim4-base/examples/exim-adduser` serves mostly as an example and is not able to handle many scenarios. For example, it won't check if the username you are providing already exists in the `passwd` file, which can lead to multiple entries for the same user, with unpredictable results.
```

Finally, update the Exim4 configuration and restart the service:

```bash
sudo update-exim4.conf
sudo systemctl restart exim4
```

## Configure SASL

To configure `saslauthd` to provide authentication for Exim4, first install the `sasl2-bin` package by running this command at a terminal prompt:

```bash
sudo apt install sasl2-bin
```

To configure `saslauthd`, edit the `/etc/default/saslauthd` configuration file and set:

```text
START=yes
```

Next, to make Exim4 use the `saslauthd` service, the *Debian-exim* user needs to be part of the *sasl* group:

```bash
sudo adduser Debian-exim sasl
```

Finally, start the `saslauthd` service:

```bash
sudo service saslauthd start
```

Exim4 is now configured with SMTP-AUTH using TLS and SASL authentication.

## References

  - See [exim.org](http://www.exim.org/) for more information.

  - Another resource is the [Exim4 Ubuntu Wiki](https://help.ubuntu.com/community/Exim4) page.

  - Further resources to [set up mailman3 with Exim4](https://mailman.readthedocs.io/en/latest/src/mailman/docs/mta.html#exim).
